<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>API Data Analytics</title>
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <nav>
        <h2>Menú Principal</h2>
        <button id="btnHome" class="active">Inicio</button>
        <button id="btnProgress">Progreso</button>
        <hr />
        <h3>Configuración API</h3>
        <input id="apiUrl" type="text" placeholder="Ingresa URL de API" style="width:100%; margin-bottom:10px;" />
        <button id="loadDataBtn" style="width: 100%;">Cargar datos</button>
    </nav>

    <main>
        <section id="homeSection">
            <h1>API DATA ANALYTICS: KPI, TRENDS & PREDICTIONS</h1>

            <div id="maxValues"></div>

            <div id="filters"></div>

            <div id="charts"></div>

            <div id="customChartControls">
                <h3>Gráfico Personalizado</h3>
                <label for="xSelect">Variable categórica (X):</label>
                <select id="xSelect"></select><br><br>

                <label for="ySelect">Variable numérica (Y):</label>
                <select id="ySelect"></select><br><br>

                <label for="chartType">Tipo de gráfico:</label>
                <select id="chartType">
                    <option value="bar">Barras</option>
                    <option value="line">Línea</option>
                    <option value="scatter">Dispersión</option>
                    <option value="histogram">Histograma</option>
                </select><br><br>

                <button id="generateChartBtn">Generar gráfico personalizado</button>
                <div id="customChartOutput" style="margin-top:20px;"></div>
            </div>

            <div id="dataTable"></div>
        </section>

        <section id="progressSection" style="display:none;">
            <h2>Progreso</h2>
            <p>Aquí puedes mostrar métricas o avances.</p>
        </section>
    </main>

    <script>
        const btnHome = document.getElementById('btnHome');
        const btnProgress = document.getElementById('btnProgress');
        const homeSection = document.getElementById('homeSection');
        const progressSection = document.getElementById('progressSection');
        const loadDataBtn = document.getElementById('loadDataBtn');
        const apiUrlInput = document.getElementById('apiUrl');
        const maxValuesDiv = document.getElementById('maxValues');
        const filtersDiv = document.getElementById('filters');
        const chartsDiv = document.getElementById('charts');
        const dataTableDiv = document.getElementById('dataTable');
        const xSelect = document.getElementById('xSelect');
        const ySelect = document.getElementById('ySelect');
        const chartTypeSelect = document.getElementById('chartType');
        const customChartOutput = document.getElementById('customChartOutput');

        let originalData = [];
        let filteredData = [];
        let dropdownOptions = []; // columnas categóricas (strings)
        let numericColumns = [];  // columnas numéricas

        // Cambiar vistas menú
        btnHome.onclick = () => {
            btnHome.classList.add('active');
            btnProgress.classList.remove('active');
            homeSection.style.display = 'block';
            progressSection.style.display = 'none';
        };
        btnProgress.onclick = () => {
            btnProgress.classList.add('active');
            btnHome.classList.remove('active');
            progressSection.style.display = 'block';
            homeSection.style.display = 'none';
        };

        // Función para obtener datos de la API con proxy
        async function fetchData(url) {
            try {
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                const res = await fetch(proxyUrl);
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const data = await res.json();
                if (!Array.isArray(data)) throw new Error("La respuesta no es un array");
                return data;
            } catch (error) {
                alert('Error al obtener datos de la API (usando proxy): ' + error.message);
                return [];
            }
        }

        // Mostrar valores máximos de columnas numéricas
        function showMaxValues(data) {
            if (data.length === 0) {
                maxValuesDiv.innerHTML = '<p>No hay datos para mostrar.</p>';
                return;
            }

            // Detectar columnas numéricas
            const sample = data[0];
            numericColumns = Object.keys(sample).filter(k => typeof sample[k] === 'number');

            if (numericColumns.length === 0) {
                maxValuesDiv.innerHTML = '<p>No hay columnas numéricas para mostrar valores máximos.</p>';
                return;
            }

            let html = '<h3>Valores Máximos Detectados</h3><div style="display:flex; gap:20px;">';
            numericColumns.forEach(col => {
                const maxVal = Math.max(...data.map(row => (row[col] != null ? row[col] : 0)));
                html += `<div style="background:#FFD700; padding:10px; border-radius:5px; flex:1;">
                        <strong>${col}</strong><br><span style="font-size:1.2em;">${maxVal.toFixed(2)}</span>
                    </div>`;
            });
            html += '</div>';
            maxValuesDiv.innerHTML = html;
        }

        // Crear filtros dinámicos para columnas categóricas (strings)
        function createFilters(data) {
            filtersDiv.innerHTML = '';
            if (data.length === 0) return;

            // Detectar columnas string para filtros
            const sample = data[0];
            dropdownOptions = Object.keys(sample).filter(k => typeof sample[k] === 'string');

            if (dropdownOptions.length === 0) {
                filtersDiv.innerHTML = '<p>No hay columnas categóricas para filtrar.</p>';
                return;
            }

            let html = '<h3>Filtros</h3>';
            dropdownOptions.forEach(col => {
                // Obtener opciones únicas
                const uniqueValues = [...new Set(data.map(row => row[col]))].sort();

                html += `<label><strong>${col}</strong></label><br>
                <select multiple id="filter-${col}">`;
                uniqueValues.forEach(val => {
                    html += `<option value="${val}" selected>${val}</option>`;
                });
                html += `</select><br><br>`;
            });
            filtersDiv.innerHTML = html;

            // Añadir listeners para filtrado
            dropdownOptions.forEach(col => {
                const selectEl = document.getElementById(`filter-${col}`);
                selectEl.addEventListener('change', applyFilters);
            });
        }

        // Aplicar filtros seleccionados
        function applyFilters() {
            filteredData = [...originalData];
            dropdownOptions.forEach(col => {
                const selectEl = document.getElementById(`filter-${col}`);
                const selectedOptions = Array.from(selectEl.selectedOptions).map(opt => opt.value);
                filteredData = filteredData.filter(row => selectedOptions.includes(row[col]));
            });

            if (filteredData.length > 0) {
                const sample = filteredData[0];
                dropdownOptions = Object.keys(sample).filter(k => typeof sample[k] === 'string');
                numericColumns = Object.keys(sample).filter(k => typeof sample[k] === 'number');
            } else {
                dropdownOptions = [];
                numericColumns = [];
            }

            showCharts(filteredData);
            showTable(filteredData);
            populateCustomChartControls();
        }

        // Mostrar tablas de datos
        function showTable(data) {
            if (data.length === 0) {
                dataTableDiv.innerHTML = '<p>No hay datos para mostrar.</p>';
                return;
            }

            let html = '<h3>Datos</h3><table><thead><tr>';
            // Cabecera con todas las columnas
            const columns = Object.keys(data[0]);
            columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';

            data.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    html += `<td>${row[col]}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            dataTableDiv.innerHTML = html;
        }

        // Mostrar gráficos predeterminados (ejemplo: barras con primeros 5 elementos y primera variable numérica)
        function showCharts(data) {
            chartsDiv.innerHTML = '<h3>Gráficos</h3><div id="chartContainer"></div>';
            if (data.length === 0) {
                chartsDiv.innerHTML += '<p>No hay datos para mostrar gráficos.</p>';
                return;
            }

            const sample = data[0];
            const numericCols = Object.keys(sample).filter(k => typeof sample[k] === 'number');
            const categoricalCols = Object.keys(sample).filter(k => typeof sample[k] === 'string');

            if (numericCols.length === 0 || categoricalCols.length === 0) {
                chartsDiv.innerHTML += '<p>No hay suficientes columnas para graficar.</p>';
                return;
            }

            // Por ejemplo, primer categórica en X y primer numérica en Y
            const xData = data.slice(0, 5).map(row => row[categoricalCols[0]]);
            const yData = data.slice(0, 5).map(row => row[numericCols[0]]);

            const trace = {
                x: xData,
                y: yData,
                type: 'bar'
            };

            Plotly.newPlot('chartContainer', [trace], { title: `Ejemplo: ${categoricalCols[0]} vs ${numericCols[0]}` });
        }

        // Llenar selects para gráfico personalizado
        function populateCustomChartControls() {
            // Limpiar selects
            xSelect.innerHTML = '';
            ySelect.innerHTML = '';

            // Si no hay columnas numéricas, mostrar mensaje en ambos
            if (numericColumns.length === 0) {
                const option = document.createElement('option');
                option.disabled = true;
                option.textContent = 'No hay variables numéricas';
                xSelect.appendChild(option.cloneNode(true));
                ySelect.appendChild(option);
            } else {
                numericColumns.forEach(opt => {
                    const optionX = document.createElement('option');
                    optionX.value = opt;
                    optionX.textContent = opt;
                    xSelect.appendChild(optionX);

                    const optionY = document.createElement('option');
                    optionY.value = opt;
                    optionY.textContent = opt;
                    ySelect.appendChild(optionY);
                });
            }
        }


        // Generar gráfico personalizado
        document.getElementById('generateChartBtn').onclick = () => {
            const xVar = xSelect.value;
            const yVar = ySelect.value;
            const chartType = chartTypeSelect.value;

            if (!xVar || !yVar) {
                alert('Selecciona ambas variables (X y Y).');
                return;
            }
            if (!filteredData.length) {
                alert('No hay datos disponibles para graficar.');
                return;
            }

            // Extraer datos para las variables seleccionadas
            const xData = filteredData.map(row => row[xVar]);
            const yData = filteredData.map(row => row[yVar]);

            let trace = {};

            if (chartType === 'histogram') {
                // Para histograma, sólo toma yData (numérico)
                trace = {
                    x: yData,
                    type: 'histogram',
                    marker: { color: '#FFD700' }
                };
            } else {
                trace = {
                    x: xData,
                    y: yData,
                    type: chartType,
                    marker: { color: '#1162ac' }
                };
            }

            const layout = {
                title: `Gráfico ${chartType} de ${yVar} vs ${xVar}`,
                xaxis: { title: xVar },
                yaxis: { title: yVar }
            };

            Plotly.newPlot(customChartOutput, [trace], layout, { responsive: true });
        };

        // Cargar datos y preparar la interfaz
        loadDataBtn.onclick = async () => {
            const url = apiUrlInput.value.trim();
            if (!url) {
                alert('Por favor ingresa una URL válida');
                return;
            }
            originalData = await fetchData(url);
            filteredData = [...originalData];

            if (originalData.length > 0) {
                const sample = originalData[0];
                dropdownOptions = Object.keys(sample).filter(k => typeof sample[k] === 'string');
                numericColumns = Object.keys(sample).filter(k => typeof sample[k] === 'number');
            } else {
                dropdownOptions = [];
                numericColumns = [];
            }

            showMaxValues(originalData);
            createFilters(originalData);
            showCharts(originalData);
            showTable(originalData);
            populateCustomChartControls();
        };
    </script>

</body>

</html>
